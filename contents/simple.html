<?xml version="1.0" encoding="Shift_JIS"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html  xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!-- generated by to_html.pl from simple.xml -->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=Shift_JIS" />
	<title>Basic Usage</title>
	<meta name="author" content="W.Dee" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta http-equiv="Content-Script-Type" content="text/javascript" />
	<link href="browser.css" type="text/css" rel="stylesheet" title="Standard Style for KiriKiri Related References" />
	<link href="mailto:dee@kikyou.info" rev="Made" />
	<link href="index.html" target="_top" rel="Start" title="Top Page" />
</head>
<body>
<h1><a id="id318" name="id318">Compilation</a>
</h1><div class="para"><div>
 Compilation is possible with Borland C++ 5.5 or later (C++ Builder 5 or later).<br />
<br />
 Compilation requires regex++ from boost.org.<br />
<br />
 After installing regex++, please compile each cpp file.<br />
<br />
 In the case of C++ Builder, it is sufficient to add all tjs2 cpp files to the project.<br />
<br />
 It can also be compiled with gcc 3 or later (it can be compiled with 2.95 as well, but requires fixes related to wstring).<br />
</div></div>
<h1><a id="id319" name="id319">Simple Example</a>
</h1><div class="para"><div>
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>#include&nbsp;&lt;stdio.h&gt;<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>#include&nbsp;&quot;tjs.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>#include&nbsp;&quot;tjsError.h&quot;<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>int&nbsp;main(int&nbsp;argc,&nbsp;char*&nbsp;argv[])<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;setlocale(LC_ALL,&nbsp;&quot;&quot;);&nbsp;<span class="comment">//&nbsp;Set&nbsp;locale</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJS&nbsp;*tjsengine&nbsp;=&nbsp;new&nbsp;tTJS();&nbsp;<span class="comment">//&nbsp;Create&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;try<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;the&nbsp;result</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&nbsp;\n&quot;<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;return&nbsp;test(4,&nbsp;5);\n&quot;),<br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;result,&nbsp;NULL,<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;test&nbsp;code&quot;));&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;test&nbsp;script</span><br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(eTJSError&nbsp;&amp;e)<br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;An&nbsp;error&nbsp;occurred&nbsp;:&nbsp;%ls\n&quot;,&nbsp;e.GetMessage().c_str());<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;catch(...)<br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;An&nbsp;error&nbsp;occurred\n&quot;);<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span><br />
<span class="linenumber">&nbsp;33|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Shutdown();&nbsp;<span class="comment">//&nbsp;Shut&nbsp;down&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;TJS2&nbsp;script&nbsp;engine</span><br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;<br />
<span class="linenumber">&nbsp;37|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>Lines 2-3</dt>
<dd>Loading the header files necessary to use TJS2. tjsError.h contains declarations regarding TJS C++ exceptions.</dd>


<dt>Line 7</dt>
<dd>The locale is specified with setlocale. If no locale is specified, it defaults to the "C" locale, which prevents proper conversion between narrow and wide characters for Japanese text.</dd>


<dt>Line 9</dt>
<dd>Creating the TJS2 script engine using the new operator.</dd>


<dt>Line 11</dt>
<dd>Entering a try block. Since TJS2 errors are notified via exceptions, exception handling must be managed carefully.</dd>


<dt>Line 13</dt>
<dd>Declaring a tTJSVariant type variable to receive the result of script execution.</dd>


<dt>Lines 15-20</dt>
<dd>Executing the script using tTJS::ExecScript.<br />
The first argument specifies the script to be executed. To pass it as a tjs_char* type, string literals are converted to wide character strings using the TJS_W macro. In the script, it defines the function 'test' and returns the result of calling that function.<br />
In this example, the result of execution is returned via a 'return' statement and received by the 'result' variable. However, if there is no need to receive a result, neither the 'return' statement nor the second argument of tTJS::ExecScript is required (in that case, specify NULL for the second argument).<br />
The third argument of tTJS::ExecScript is the execution context; here, NULL is specified. Specifying NULL executes the script in the global context.<br />
The fourth argument of tTJS::ExecScript specifies the name of this script. If NULL, it is treated as anonymous. It should be a human-readable name.</dd>


<dt>Line 22</dt>
<dd>Displaying the result. Here, tTJSVariant is cast to an int type.</dd>


<dt>Line 24</dt>
<dd>Catching an exception of type eTJSError.</dd>


<dt>Line 26</dt>
<dd>Displaying the reason for the exception using eTJSError::GetMessage. tTJSString::c_str is used to convert the message to const tjs_char *. Since tjs_char is a wide character, %ls is used as the conversion specifier for printf.</dd>


<dt>Line 28</dt>
<dd>Catching other exceptions.</dd>


<dt>Lines 33-34</dt>
<dd>Releasing the TJS2 script engine. Prior to release, the TJS2 script engine is shut down using tTJS::Shutdown.</dd></dl></div></div>

<h1><a id="id320" name="id320">Calling Functions on the TJS2 Side</a>
</h1><div class="para"><div>
 This is how to call a function declared on the TJS2 side from C++.<br />
 Let's try writing the inside of the aforementioned try block as follows.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;the&nbsp;result</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_W(&quot;function&nbsp;test(x,&nbsp;y)&nbsp;{&nbsp;return&nbsp;x*y;&nbsp;}&quot;),&nbsp;NULL,&nbsp;NULL,&nbsp;TJS_W(&quot;test&quot;));<br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;expression&nbsp;using&nbsp;tTJS::EvalExpression</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;13|</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;param[]&nbsp;=&nbsp;{&nbsp;4,&nbsp;5&nbsp;};&nbsp;<span class="comment">//&nbsp;Variables&nbsp;to&nbsp;pass&nbsp;as&nbsp;parameters</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;*p_param[]&nbsp;=&nbsp;{&nbsp;param&nbsp;+&nbsp;0,&nbsp;param&nbsp;+&nbsp;1&nbsp;};&nbsp;<span class="comment">//&nbsp;Array&nbsp;of&nbsp;pointers&nbsp;to&nbsp;variables</span><br />
<span class="linenumber">&nbsp;16|</span><br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(global-&gt;FuncCall(0,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;result,&nbsp;2,&nbsp;p_param,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Call&nbsp;'test'&nbsp;as&nbsp;a&nbsp;function</span><br />
<span class="linenumber">&nbsp;20|</span><br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
</code>
<br />

<br />
<dl>
<dt>Lines 3-4</dt>
<dd>Declaring function 'test'. 'test' is registered to global.</dd>


<dt>Line 6</dt>
<dd>Executing an expression using tTJS::EvalExpression. If performance is not extremely critical, it's easier to pass the expression as a string and receive the result like this.<br />
Incidentally, for simple expressions (those that do not include other execution units like function declarations), the compilation results are cached to some extent, allowing subsequent evaluations to be performed quickly.</dd>


<dt>Line 11</dt>
<dd>Getting the global object. The difference between tTJS::GetGlobal and tTJS::GetGlobalNoAddRef is that the former increments the reference counter of the global object, while the latter does not.<br />
Incrementing the reference counter and decrementing it when finished means locking the object so it isn't destroyed in the meantime. In cases like this example, where there is no concern about the global object disappearing, there's no need to manipulate the reference counter, so tTJS::GetGlobalNoAddRef can be used. Also, in this case, Release is not necessary when finished.</dd>


<dt>Lines 14-15</dt>
<dd>Preparing the parameters to pass to the function. Since iTJSDispatch::FuncCall requires an array of pointers to tTJSVariant types as parameters, this preparation is necessary.</dd>


<dt>Line 17</dt>
<dd>Calling the function "test" using iTJSDispatch2::FuncCall.<br />
The final argument of FuncCall is the 'this' (execution context) passed to the 'test' function, but since 'this' is not used within the 'test' declared in this example, specifying NULL is fine. If there is a context that should be executed, that object must be specified.<br />
TJS_THROW_IF_ERROR is a macro that throws an exception along with the corresponding error message if the tjs_error result is an error.</dd></dl></div></div>

<h1><a id="id321" name="id321">Native Functions</a>
</h1><div class="para"><div>
 You can create native implementations (functions implemented in C++, etc.) and access them from the TJS2 side.<br />
 Even if it's not C++, as long as the language can implement iTJSDispatch2, functions written in any language can be called, but C++ is probably the easiest.<br />
<br />
 When writing functions in C++, it is easiest to derive a class from tTJSNativeFunction (described in tjsNative.h) (however, it can function as a function just by implementing iTJSDispatch2's FuncCall).<br />
<br />
 Let's implement a simple function that multiplies two given arguments and returns the result.<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;TestFunc&nbsp;:&nbsp;public&nbsp;tTJSNativeFunction<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;Process(tTJSVariant&nbsp;*result,&nbsp;tjs_int&nbsp;numparams,<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*objthis)<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;2)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;&nbsp;<span class="comment">//&nbsp;Not&nbsp;enough&nbsp;arguments</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span><br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!result)&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;If&nbsp;the&nbsp;result&nbsp;doesn't&nbsp;need&nbsp;to&nbsp;be&nbsp;stored,&nbsp;return&nbsp;immediately</span><br />
<span class="linenumber">&nbsp;10|</span><br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;*param[0]&nbsp;*&nbsp;*param[1];&nbsp;<span class="comment">//&nbsp;Calculation</span><br />
<span class="linenumber">&nbsp;12|</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;&nbsp;<span class="comment">//&nbsp;Return&nbsp;TJS_S_OK&nbsp;to&nbsp;indicate&nbsp;normal&nbsp;completion</span><br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;15|</span>};<br />
</code>
<br />

<br />
 As shown above, the only method that needs to be implemented in a class inheriting from tTJSNativeFunction is the Process method.<br />
 The arguments for the Process method are as follows:<br />
<br />
<dl>
<dt>tTJSVariant *result</dt>
<dd> A pointer to a tTJSVariant type variable for storing the function result is passed. <em>Please note that NULL is passed if the caller does not require a result</em>.</dd>


<dt>tjs_int numparams</dt>
<dd> The number of arguments passed to the function.</dd>


<dt>tTJSVariant **param</dt>
<dd> An array of pointers to tTJSVariant type variables where the arguments passed to the function are stored.</dd>


<dt>iTJSDispatch2 *objthis</dt>
<dd> The context in which the function should be executed. This can be ignored if the implementation is context-independent.</dd></dl><br />
<br />
<br />
 To make a native function accessible from TJS2, it must be registered to an object accessible within TJS2. In the following example, it is registered under the name "test" in global. Additionally, the function is actually called.<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*func&nbsp;=&nbsp;new&nbsp;TestFunc();&nbsp;<span class="comment">//&nbsp;Create&nbsp;TestFunc&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;func_var(func);&nbsp;<span class="comment">//&nbsp;Set&nbsp;object&nbsp;to&nbsp;tTJSVariant&nbsp;type&nbsp;func_var</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;func</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;test&quot;),&nbsp;NULL,&nbsp;&amp;func_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Registration</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;result;&nbsp;<span class="comment">//&nbsp;Variable&nbsp;to&nbsp;receive&nbsp;the&nbsp;result</span><br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;EvalExpression(TJS_W(&quot;test(4,&nbsp;5)&quot;),&nbsp;&amp;result,&nbsp;NULL,&nbsp;NULL);<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Execute&nbsp;expression&nbsp;using&nbsp;tTJS::EvalExpression</span><br />
<span class="linenumber">&nbsp;15|</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Result&nbsp;:&nbsp;%d\n&quot;,&nbsp;(int)result);&nbsp;<span class="comment">//&nbsp;Display&nbsp;result</span><br />
</code>
<br />

<br />
<dl>
<dt>Lines 4-6</dt>
<dd>Creating an object of class TestFunc, which implements the native function, and converting it to a tTJSVariant type.<br />
It is converted to tTJSVariant type in line 5. Since tTJSVariant automatically manages the reference counter of the function object at this point, the function object is released in line 6.</dd>


<dt>Lines 8-9</dt>
<dd>Registering the function under the name "test" in the global object. iTJSDispatch2::PropSet of the global object is called, using the TJS_MEMBERENSURE flag to create a new member.</dd>


<dt>Lines 12-16</dt>
<dd>Actually calling the function and displaying the result.</dd></dl></div></div>
<h1><a id="id322" name="id322">Native Classes</a>
</h1><div class="para"><div>
 TJS2 has a mechanism for handling native classes written in languages like C++.<br />
 Each object (iTJSDispatch2 interface) can have an object called a native instance of type iTJSNativeInstance registered to it, which can then be retrieved from the object.<br />
 Native instances are identified by a unique class ID, and the class ID must be obtained when creating a native class.<br />
<br />
 However, since a set of macros for performing these operations is defined in tjsNative.h, it is easier to use them.<br />
 The following example implements a simple class using these macros.<br />
<br />
 First is the implementation of the native instance. To implement a native instance, derive a class from tTJSNativeInstance. tTJSNativeInstance is a class implemented in tjsNative.cpp / tjsNative.h that implements the basic behavior of iTJSNativeInstance.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NI_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeInstance&nbsp;<span class="comment">//&nbsp;Native&nbsp;instance</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NI_Test()<br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Constructor</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;0;<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;&nbsp;9|</span><br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_error&nbsp;TJS_INTF_METHOD<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Construct(tjs_int&nbsp;numparams,&nbsp;tTJSVariant&nbsp;**param,&nbsp;iTJSDispatch2&nbsp;*tjs_obj)<br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Called&nbsp;when&nbsp;a&nbsp;TJS2&nbsp;object&nbsp;is&nbsp;created</span><br />
<span class="linenumber">&nbsp;14|</span><br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;If&nbsp;there&nbsp;are&nbsp;arguments,&nbsp;put&nbsp;them&nbsp;into&nbsp;Value&nbsp;as&nbsp;the&nbsp;initial&nbsp;value</span><br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&gt;=&nbsp;1&nbsp;&amp;&amp;&nbsp;param[0]-&gt;Type()&nbsp;!=&nbsp;tvtVoid)<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;=&nbsp;(tjs_int)*param[0];<br />
<span class="linenumber">&nbsp;18|</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;S_OK;<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;21|</span><br />
<span class="linenumber">&nbsp;22|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;TJS_INTF_METHOD&nbsp;Invalidate()<br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;24|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Called&nbsp;when&nbsp;the&nbsp;object&nbsp;is&nbsp;invalidated</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;26|</span><br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;SetValue(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;28|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetValue()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value;&nbsp;}<br />
<span class="linenumber">&nbsp;29|</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;GetSquare()&nbsp;const&nbsp;{&nbsp;return&nbsp;Value*Value;&nbsp;}<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Add(tjs_int&nbsp;n)&nbsp;{&nbsp;Value&nbsp;+=&nbsp;n;&nbsp;}<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;Print()&nbsp;const&nbsp;{&nbsp;printf(&quot;%d\n&quot;,&nbsp;Value);&nbsp;}<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>private:<br />
<span class="linenumber">&nbsp;35|</span>&nbsp;&nbsp;&nbsp;&nbsp;tjs_int&nbsp;Value;&nbsp;<span class="comment">//&nbsp;Value</span><br />
<span class="linenumber">&nbsp;36|</span>};<br />
</code>
<br />

<br />
<dl>
<dt>Line 35</dt>
<dd>Returning to an earlier point, this is a data member. You can freely write necessary data members in a native instance.</dd>

<dt>Lines 4-8</dt>
<dd>The constructor for NI_Test. We recommend performing C++ class initialization here rather than in the Construct method mentioned later, and keeping initialization in Construct to a minimum.<br />
In this example, the data member Value is set to an initial value of 0.</dd>


<dt>Lines 10-20</dt>
<dd>Called when a TJS2 object is created with the new operator. The numparams and param arguments represent the arguments passed to the new operator.<br />
The tjs_obj argument is the TJS object being created.<br />
In this example, if there is an argument (and it is not void), it is set as the initial value for Value.</dd>


<dt>Lines 22-25</dt>
<dd>This method is called when the object is invalidated. It is appropriate to write cleanup processing here.<br />
In this example, it does nothing.</dd>


<dt>Lines 27-32</dt>
<dd>Public methods for manipulating data members. Code using these will be written within the native class described later.</dd></dl><br />
 A class is required to create an object, so we describe the class. The class is implemented by deriving from tTJSNativeClass. tTJSNativeClass has an iTJSDispatch2 interface and implements the basic behavior for acting as a native class.<br />
 Methods and properties accessible from TJS are described within the constructor of the native class.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>class&nbsp;NC_Test&nbsp;:&nbsp;public&nbsp;tTJSNativeClass&nbsp;<span class="comment">//&nbsp;Native&nbsp;class</span><br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>public:<br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;Constructor;&nbsp;described&nbsp;below</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;tjs_uint32&nbsp;ClassID;&nbsp;<span class="comment">//&nbsp;Class&nbsp;ID</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>private:<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;tTJSNativeInstance&nbsp;*CreateNativeInstance()<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;NI_Test();&nbsp;<span class="comment">//&nbsp;Create&nbsp;and&nbsp;return&nbsp;a&nbsp;native&nbsp;instance</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;13|</span>};<br />
<span class="linenumber">&nbsp;14|</span>tjs_uint32&nbsp;NC_Test::ClassID&nbsp;=&nbsp;(tjs_uint32)-1;&nbsp;<span class="comment">//&nbsp;Class&nbsp;ID</span><br />
</code>
<br />

<br />
<dl>
<dt>Line 4</dt>
<dd>The constructor for this class. Its implementation is described later.</dd>


<dt>Line 6</dt>
<dd>A variable to hold the class ID for this class. Its entity is in line 14.</dd>


<dt>Lines 9-12</dt>
<dd>The CreateNativeInstance method is called when a native instance needs to be created. Here, an object of the NI_Test class is created and returned.</dd></dl><br />
<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>NC_Test::NC_Test()&nbsp;:&nbsp;tTJSNativeClass(TJS_W(&quot;Test&quot;))<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>{<br />
<span class="linenumber">&nbsp;&nbsp;3|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_MEMBERS(<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;&nbsp;4|</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DECL_EMPTY_FINALIZE_METHOD<br />
<span class="linenumber">&nbsp;&nbsp;6|</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL(<br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.name*/</span>_this,<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.type*/</span>NI_Test,<br />
<span class="linenumber">&nbsp;&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;&nbsp;11|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Since&nbsp;content&nbsp;can&nbsp;also&nbsp;be&nbsp;written&nbsp;in&nbsp;NI_Test::Construct</span><br />
<span class="linenumber">&nbsp;&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;do&nbsp;nothing&nbsp;here</span><br />
<span class="linenumber">&nbsp;&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_CONSTRUCTOR_DECL(<span class="comment">/*TJS&nbsp;class&nbsp;name*/</span>Test)<br />
<span class="linenumber">&nbsp;&nbsp;17|</span><br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>print)&nbsp;<span class="comment">//&nbsp;print&nbsp;method</span><br />
<span class="linenumber">&nbsp;19|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;20|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;21|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;22|</span><br />
<span class="linenumber">&nbsp;23|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Print();<br />
<span class="linenumber">&nbsp;24|</span><br />
<span class="linenumber">&nbsp;25|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;26|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;27|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>print)<br />
<span class="linenumber">&nbsp;28|</span><br />
<span class="linenumber">&nbsp;29|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>add)&nbsp;<span class="comment">//&nbsp;add&nbsp;method</span><br />
<span class="linenumber">&nbsp;30|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;31|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;32|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;33|</span><br />
<span class="linenumber">&nbsp;34|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(numparams&nbsp;&lt;&nbsp;1)&nbsp;return&nbsp;TJS_E_BADPARAMCOUNT;<br />
<span class="linenumber">&nbsp;35|</span><br />
<span class="linenumber">&nbsp;36|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;Add((tjs_int)*param[0]);<br />
<span class="linenumber">&nbsp;37|</span><br />
<span class="linenumber">&nbsp;38|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;39|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;40|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_METHOD_DECL(<span class="comment">/*func.&nbsp;name*/</span>add)<br />
<span class="linenumber">&nbsp;41|</span><br />
<span class="linenumber">&nbsp;42|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(value)&nbsp;<span class="comment">//&nbsp;value&nbsp;property</span><br />
<span class="linenumber">&nbsp;43|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;44|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;45|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;46|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;47|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;48|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetValue();<br />
<span class="linenumber">&nbsp;49|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;50|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;51|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;52|</span><br />
<span class="linenumber">&nbsp;53|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;54|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;55|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;56|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;57|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_this-&gt;SetValue((tjs_int)*param);<br />
<span class="linenumber">&nbsp;58|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;59|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;60|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;61|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;62|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(value)<br />
<span class="linenumber">&nbsp;63|</span><br />
<span class="linenumber">&nbsp;64|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_DECL(square)&nbsp;<span class="comment">//&nbsp;square&nbsp;read-only&nbsp;property</span><br />
<span class="linenumber">&nbsp;65|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;66|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_BEGIN_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;67|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br />
<span class="linenumber">&nbsp;68|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_GET_NATIVE_INSTANCE(<span class="comment">/*var.&nbsp;name*/</span>_this,<br />
<span class="linenumber">&nbsp;69|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">/*var.&nbsp;type*/</span>NI_Test);<br />
<span class="linenumber">&nbsp;70|</span><br />
<span class="linenumber">&nbsp;71|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*result&nbsp;=&nbsp;_this-&gt;GetSquare();<br />
<span class="linenumber">&nbsp;72|</span><br />
<span class="linenumber">&nbsp;73|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TJS_S_OK;<br />
<span class="linenumber">&nbsp;74|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;75|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_GETTER<br />
<span class="linenumber">&nbsp;76|</span><br />
<span class="linenumber">&nbsp;77|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_DENY_NATIVE_PROP_SETTER<br />
<span class="linenumber">&nbsp;78|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />
<span class="linenumber">&nbsp;79|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_PROP_DECL(square)<br />
<span class="linenumber">&nbsp;80|</span><br />
<span class="linenumber">&nbsp;81|</span>&nbsp;&nbsp;&nbsp;&nbsp;TJS_END_NATIVE_MEMBERS<br />
<span class="linenumber">&nbsp;82|</span>}<br />
</code>
<br />

<br />
<dl>
<dt>Line 1</dt>
<dd>The constructor for NC_Test. Specify the class name to be used within TJS2 in the constructor of the parent class, tTJSNativeClass.</dd>


<dt>Line 3</dt>
<dd>The TJS_BEGIN_NATIVE_MEMBERS macro. Specify the class name used within TJS2 as the argument.<br />
Methods and properties that should be members of the class are described between this macro and the TJS_END_NATIVE_MEMBERS macro.</dd>


<dt>Line 4</dt>
<dd>An empty finalize method is declared. Since processing equivalent to finalize can also be implemented by overriding tTJSNativeInstance::Invalidate, an empty method is usually sufficient.
</dd>


<dt>Lines 7-16</dt>
<dd>Declaring the (TJS) constructor. This corresponds to the part where you declare a method with the same name as the class within the class when writing a class in TJS.<br />
<br />
The first argument of the TJS_BEGIN_NATIVE_CONSTRUCTOR_DECL macro is the variable name to assign to the native instance, and the second argument is the type name of that variable. Within this block in this example, a variable NI_Test * _this is available, allowing access to the native instance.<br />
The third argument of the macro specifies the class name used within TJS. The same applies to the arguments of the TJS_END_NATIVE_CONSTRUCTOR_DECL macro.<br />
Again, since processing equivalent to the constructor can be implemented by overriding tTJSNativeInstance::Construct, it does nothing here and returns S_OK.
</dd>


<dt>Lines 18-27</dt>
<dd>Declaring the print method. The same method name must be specified for both TJS_BEGIN_NATIVE_METHOD_DECL and TJS_END_NATIVE_METHOD_DECL macros.<br />
Within this macro, variables tjs_int numparams and tTJSVariant **param are available, representing the number of arguments passed and the arguments themselves, respectively. This method does not use them.<br />
Lines 20-21 are a macro for retrieving the native instance from the object. In this example, it means retrieving the native instance into a variable named _this of type NI_Test *. Henceforth, the native instance can be accessed via the _this variable. In line 23, the Print method of that native instance is called.</dd>


<dt>Lines 29-40</dt>
<dd>Declaring the add method. Here, numparams and param are used.</dd>



<dt>Lines 42-62</dt>
<dd>Declaring the value property. Similar to method declarations, specify the property name for both TJS_BEGIN_NATIVE_PROP_DECL and TJS_END_NATIVE_PROP_DECL macros.<br />
<br />
A getter can be written between the TJS_BEGIN_NATIVE_PROP_GETTER and TJS_END_NATIVE_PROP_GETTER macros. Inside the getter, write it so that a value is set to *result, which is of type tTJSVariant.<br />
Similarly, a setter can be written between the TJS_BEGIN_NATIVE_PROP_SETTER and TJS_END_NATIVE_PROP_SETTER macros. Inside the setter, *param of type tTJSVariant contains the value to be set, so use that for processing.</dd>


<dt>Lines 64-79</dt>
<dd>A read-only property is declared here. By writing TJS_DENY_NATIVE_PROP_SETTER instead of a setter, you can create a read-only property.</dd></dl><br />
<br />
<br />
 Registration of a native class is the same as registration of a native function. Test code is illustrated below.<br />
<br />

<br />
<code class="bq"><span class="weak">Example:</span><br /><span class="linenumber">&nbsp;&nbsp;1|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*&nbsp;global&nbsp;=&nbsp;tjsengine-&gt;GetGlobalNoAddRef();<br />
<span class="linenumber">&nbsp;&nbsp;2|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;global&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;3|</span><br />
<span class="linenumber">&nbsp;&nbsp;4|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iTJSDispatch2&nbsp;*cls&nbsp;=&nbsp;new&nbsp;NC_Test();&nbsp;<span class="comment">//&nbsp;Create&nbsp;NC_Test&nbsp;object</span><br />
<span class="linenumber">&nbsp;&nbsp;5|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tTJSVariant&nbsp;cls_var(cls);&nbsp;<span class="comment">//&nbsp;Set&nbsp;object&nbsp;to&nbsp;tTJSVariant&nbsp;type&nbsp;cls_var</span><br />
<span class="linenumber">&nbsp;&nbsp;6|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cls-&gt;Release();&nbsp;<span class="comment">//&nbsp;Release&nbsp;cls</span><br />
<span class="linenumber">&nbsp;&nbsp;7|</span><br />
<span class="linenumber">&nbsp;&nbsp;8|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TJS_THROW_IF_ERROR(<br />
<span class="linenumber">&nbsp;&nbsp;9|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global-&gt;PropSet(TJS_MEMBERENSURE,&nbsp;TJS_W(&quot;Test&quot;),&nbsp;NULL,&nbsp;&amp;cls_var,&nbsp;NULL));<br />
<span class="linenumber">&nbsp;10|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Registration</span><br />
<span class="linenumber">&nbsp;11|</span><br />
<span class="linenumber">&nbsp;12|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tjsengine-&gt;ExecScript(TJS_W(<br />
<span class="linenumber">&nbsp;13|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test&nbsp;=&nbsp;new&nbsp;Test();\n&quot;<br />
<span class="linenumber">&nbsp;14|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test.value&nbsp;=&nbsp;5;\n&quot;<br />
<span class="linenumber">&nbsp;15|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;var&nbsp;test2&nbsp;=&nbsp;new&nbsp;Test(test.square);\n&quot;<br />
<span class="linenumber">&nbsp;16|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.add(3);\n&quot;<br />
<span class="linenumber">&nbsp;17|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;test2.print();\n\0&quot;),<br />
<span class="linenumber">&nbsp;18|</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&nbsp;<span class="comment">//&nbsp;Execute&nbsp;script</span><br />
</code>
<br />

<br />
</div></div>
	<script type="text/javascript" charset="Shift_JIS" src="documentid.js" ></script>
	<script type="text/javascript" charset="Shift_JIS" src="postcontent.js" ></script>
</body>
</html>